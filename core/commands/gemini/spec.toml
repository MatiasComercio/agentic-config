description = "Execute /spec workflow (RESEARCH, PLAN, IMPLEMENT) - Usage: /spec <STAGE> [SPEC_PATH]"

prompt = """
Arguments provided: {{args}}

## INSTRUCTIONS

### 1. Parse Arguments

- **If 2+ words provided:**
  - STAGE = first word (convert to UPPERCASE: research→RESEARCH, plan→PLAN, implement→IMPLEMENT)
  - SPEC_PATH = all remaining text after first word

- **If 1 word OR empty:**
  - STAGE = that word (convert to UPPERCASE), or ask user which stage if empty
  - SPEC_PATH = [DERIVE FROM CONTEXT]

### 2. Derive SPEC_PATH from Context (if needed)

If SPEC_PATH is [DERIVE FROM CONTEXT]:
1. Search backwards through our conversation history
2. Look for patterns:
   - `/spec <stage> <file_path>`
   - `/spec:research <file_path>`
   - `/spec:plan <file_path>`
   - `/spec:implement <file_path>`
3. Extract the most recent <file_path> (typically starts with `specs/` or `@specs/`)
4. Use that as SPEC_PATH
5. **If no previous /spec command found:** Respond with error:
   ```
   ERROR: No spec file in context.
   Usage: /spec <STAGE> <SPEC_PATH>
   Example: /spec research specs/2025/11/21/001-repo-init/001.md
   ```

### 3. Read Stage Instructions

Read the file at path: `agents/spec/{STAGE}.md`

Available stages:
- `agents/spec/RESEARCH.md`
- `agents/spec/PLAN.md`
- `agents/spec/IMPLEMENT.md`

### 4. Read Target Spec File

Read the spec file at SPEC_PATH (remove `@` prefix if present)

### 5. Execute Workflow

Follow the EXACT workflow steps defined in `agents/spec/{STAGE}.md` against the target spec file.

### 6. Important Notes

- RIGHT AFTER starting: RE-READ both the stage file (`agents/spec/{STAGE}.md`) and the spec file (SPEC_PATH)
- REFLECT exact steps you will take based on your understanding
- WAIT for explicit user confirmation ("OK" or equivalent)
- EXECUTE the stage workflow as defined in the stage file
- COMMIT ONLY the files modified during this stage

Refer to AGENTS.md for complete /spec workflow documentation.

## EXAMPLES

**With explicit path:**
```
User: /spec research specs/2025/11/21/001-repo-init/001.md
→ STAGE=RESEARCH, SPEC_PATH=specs/2025/11/21/001-repo-init/001.md
```

**Context-derived path:**
```
User: /spec research specs/2025/11/21/001-repo-init/001.md
... (workflow executes)
User: /spec plan
→ STAGE=PLAN, SPEC_PATH=specs/2025/11/21/001-repo-init/001.md (derived from previous)
```
"""
